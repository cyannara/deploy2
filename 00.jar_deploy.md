## 수업 시간에 사용하려는 포트 번호가 이미 사용되고 있는지 확인

8080, 9090, 3306

```sh
# 포트번호가 사용중인지 체크하는 명령
netstat -ano | findstr 체크하려는포트번호

# 어떤 애플리케이션이 사용중인지 체크하는 명령
tasklist /FI "PID eq 프로세스번호"

# 해당 애플리케이션을 강제 종료하는 명령 (관리자모드 파워쉘)
taskkill /F /PID 프로세스번호
```

## 학습용 폴더 생성

```
c:\edu_deploy
```

## jar 배포

### 작업순서

1. 빌드하고 배포파일(jar 또는 war) 테스트
2. EC2 인스턴스 생성
3. jar파일 업로드
4. 타임존 변경
5. JDK 설치
6. jar 실행,재시작하는 스크립트 작성
7. 실시간 로그확인
8. Jenkins에서 EC2로 배포하기
9. 파일업로드 경로 설정
10. 환경변수 설정
11. 오류발생 시 대처

### 1. 빌드하고 배포파일(jar 또는 war) 테스트

A. 빌드하기

- 이클립스에서 실행하는 경우
  1.  프로젝트 컨텍스트메뉴 => run as => maven install
  2.  target폴더에 jar파일 생성됨 (war)

- cmd 창에서 실행

```sh
	mvn install
	mvn clean package
	mvn install -DskipTests
```

B. 배포파일(jar) 테스트

```
   cd C:\Users\admin\git\[github repository]\[프로젝트명]

  - jasypt 패스워드가 있는경우
    1. 환경변수 설정
    set jasypt.encryptor.password=xxxxx

    2. 명령행 인수에 프로퍼티로 지정
    start java -jar -Dserver.port=85 target/project-0.0.1-SNAPSHOT.jar

    또는

    java -jar -Dserver.port=86 ex01-0.0.1-SNAPSHOT.jar  --jasypt.encryptor.password=xxxx

  - active property를 지정하는 경우
    start java -jar -Djasyptkey="pet!@" pettopia.jar --spring.profiles.active=linux

    또는

     start java -jar -Djasyptkey="pet!@" -Dspring.profiles.active=linux   pettopia.jar
```

C. 브라우저 확인

```
   http://localhost:8090
```

application.properties

```sh
server.port=8080
server.servlet.context-path=/test


application-dev.properties
server.port=80
server.servlet.context-path=/
```

```sh
 java -jar project.jar
http://ip주소:8080/test/custList

# sudo java -jar project.jar --spring.profiles.active=dev

http://ip주소:80/custList
```

D 메이븐 빌드 시 발생하는 오류 대처

- test 스킵 설정
  skiptest pom.xml에서 <build>안에 skipTests를 true로 설정
  또는 mvn 실행할 때 -DskipTests 옵션을 지정

```

      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-surefire-plugin</artifactId>
        <version>2.19.1</version>
        <configuration>
          <skipTests>true</skipTests>
        </configuration>
      </plugin>
```

- mapper.xml 배포되지 않는 경우
  원인 : java 밑에 있는 xml 파일은 배포안함.(원래위치는 resources임)
  해결책 : spring 프로젝트에서 mapper.xml이 src/main/java 밑에 있는 매퍼파일도 배포파일에 포함되도록 빌드 옵션 추가

```sh

<build>
	<resources>
		<resource>
			<directory>src/main/resources</directory>
		</resource>
		<resource>
			<directory>src/main/java</directory>
			<includes>
				<include>**/*.xml</include>
			</includes>
		</resource>
	</resources>
</build>
```

- 인코딩 에러 발생하면

```xml
<properties>
    <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
</properties>
```

■ 2. EC2 인스턴스 생성
A. 인스턴스명 : server
B. 키파일 다운로드
C. ~~방화벽,포트 설정파일
D. EBS용량 30gb

■ 3. jar파일 업로드

1. scp 명령으로 ec2서버에 jar 파일 업로드(윈도우)

```sh
   scp -i "ci_server.pem" pettopia.jar ec2-user@ip또는도메인:~
```

2. ssh 명령으로 서버연결(윈도우)

```sh
   ssh -i "ci_server.pem" ec2-user@ip또는도메인
```

■ 4. 타임존 변경 (EC2)

```sh
$ sudo rm /etc/localtime
$ sudo ln -s /usr/share/zoneinfo/Asia/Seoul /etc/localtime
$ date
```

■ 5. JDK 설치 (EC2)
A. 자바 설치 가능 리스트 검색

```sh
$ sudo yum list java\*

B. jdk(Amazon Corretto OpenJDK) 설치
$ sudo yum install -y java-17-amazon-corretto.x86_64
$ java -version
$ echo $JAVA_HOME
```

C. 자바 설치 경로 확인 (선택)

```sh
$ whhich java
$ readlink -f /usr/bin/java
```

D. 환경변수 설정 (선택)

```sh
$ sudo vi /etc/profile
=> Shift+g(맨 마지막으로 이동) => i(insert모드) => 아래의 export정보 입력 => esc => :wq

export JAVA_HOME=/usr/lib/jvm/java-17-amazon-corretto.x86_64
export PATH=$PATH:$JAVA_HOME/bin
export CLASSPATH=$JAVA_HOME/jre/lib:$JAVA_HOME/lib/tools.jar <== 확인

    $ sudo source /etc/profile
```

■ 6. jar 실행,재시작하는 스크립트 작성

A. jar 실행

```sh
java -jar \
 -Djasyptkey=pet \
 /home/ec2-user/deploy/pettopia-0.0.1-SNAPSHOT.jar \
 --spring.profiles.active=linux >> /home/ec2-user/logs/tomcat.log 2>&1 &
```

B. jar 재시작하는 스크립트 작성

```
vi start_server.sh
```

```
echo "Start Spring Boot Application!"
CURRENT_PID=$(ps -ef | grep java | grep pettopia | awk '{print $2}')
echo "$CURRENT_PID"

if [ -z $CURRENT_PID ]; then
echo ">Since there is no currently running application, it will not exit.."

else
echo "> kill -9 $CURRENT_PID"
sudo kill -9 $CURRENT_PID
sleep 10
fi

echo ">Application distribution progress!"
sudo java -jar -Djasyptkey=pet /home/ec2-user/deploy/pettopia-0.0.1-SNAPSHOT.jar --spring.profiles.active=linux >> /home/ec2-user/logs/tomcat.log 2>&1 &
echo ">end sh"
```

■ 7. 실시간 로그보기

```sh
$ tail -f tomcat.log
```

■ 8. Jenkins에서 EC2로 배포하기
참고사이트 : https://velog.io/@sa1341/Jenkins에서-EC2로-배포하기

==> [jenkins_jar] 폴더 참조

1. Publish Over SSH 플러그인 설치
2. 시스템 설정
3. Jenkins Item 구성
   - build
   - 빌드 후 조치
4. Jenkins 빌드

■ 9. 파일업로드 경로 설정

1. 리눅스용 properties 파일 생성

- 파일복사
  application.properties 파일 복사하여 application-linux.properties

- linux 퍼로퍼티 파일에 내용 추가

```sh
upload.url=/upload/
upload.path=/home/ec2-user/upload/

```

- default 퍼로퍼티 파일(window경로 인 경우)

```sh
upload.url=/upload/
upload.path=d:/upload/

```

2. 외부 리소스 경로 추가

```
@Configuration
public class MvcConfig implements WebMvcConfigurer {

    @Value("${upload.path}")
    String path;

    @Value("${upload.url}")
    String url;

    @Override
    public void addResourceHandlers(final ResourceHandlerRegistry registry) {
          registry.addResourceHandler(url+"**")
            .addResourceLocations("file://"+path)
            .setCacheControl(CacheControl.maxAge(1, TimeUnit.MINUTES));  // 접근 파일 캐싱 시간
    }
}
```

■ 10. 환경변수 설정

1. 임시로 지정

```

$ export jasyptkey=pet
$ echo $jasyptkey

```

2. 영구적으로 지정

```

$ sudo vi /etc/profile
shift + g(맨마지막으로 이동) -> o(입력모드) -> 아래의 내용 작성 -> ESC -> :wq

export jasyptkey=pet

$ source /etc/profile

```

■ 11. 오류발생 시 대처

A. spring.profiles.active 설정이 오류나는 경우

```

org.springframework.boot.SpringApplication - Application run failed
org.springframework.boot.context.config.InvalidConfigDataPropertyException: Property 'spring.profiles.active' imported from location 'class path resource [application-dev.yml]' is invalid in a profile specific resource [origin: class path resource [application-dev.yml] from project.jar - 40:xx]

해결책
--spring.config.activate.on-profile=linux <== 부트버전따라서 옵션이 다름

```

B. 원격 shell 실행 시 job이 끝나지 않는 현상

jenkins 에서 nohup으로 background 프로세스 수행시, 위와 같이 job이 끝나지 않는 경우가 있다.
SSH를 통해 스크립트를 수행시, 표준 출력이 닫히거나 timeout이 발생할 때 까지 스크립트가 계속해서 열려있게 된다.
그래서 script로 백그라운드 작업 수행시에는, 아래와 같이 모든 output을 redirect 해줘야 스크립트가 바로 종료가 된다.

```

해결책
nohup ./program > /dev/null 2>&1 &

2>&1 는 표준에러를 표준출력으로 redirection 하라는 의미이다.
에러가 발생하면 프로그램이 작동을 멈추거나 꺼지지않게 하고, 대신 에러내용을 표준 출력 동작으로 행동하게 하여 프로그램은 오류가 있더라도
화면에 경고메세지를 출력하지 말고 파일이나 딴 곳으로 처리하고, 어쨋든 계속 실행하라는 의미로 볼 수 있다.

0 : 표준입력
1 : 표준출력
2 : 표준에러
```
